<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chess.org Login</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #fff;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem;
  }
  #app {
    background: rgba(0,0,0,0.45);
    border-radius: 16px;
    max-width: 520px;
    width: 100%;
    padding: 2rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  }
  h1 {
    text-align: center;
    margin-bottom: 1.5rem;
    font-weight: 600;
    letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
  }
  .hidden { display: none; }
  input[type="text"] {
    width: 100%;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    border-radius: 12px;
    border: none;
    font-size: 1rem;
    font-weight: 600;
    outline: none;
  }
  button {
    background: #ffd369;
    border: none;
    padding: 0.75rem 1rem;
    width: 100%;
    border-radius: 12px;
    font-weight: 700;
    color: #2d2d2d;
    font-size: 1rem;
    cursor: pointer;
    margin-bottom: 1rem;
  }
  button:hover { background: #ffb800; color: #1a1a1a; }

  #messages, #globalMessages {
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 1rem;
    height: 320px;
    overflow-y: auto;
    margin-bottom: 1rem;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.25);
    white-space: pre-wrap;
    font-weight: 600;
  }

  .message { margin-bottom: 0.75rem; max-width: 80%; padding: 0.5rem 0.75rem; border-radius: 12px; background: rgba(255,255,255,0.15); }
  .message.self { background: #ffd369; color: #2d2d2d; margin-left: auto; }
</style>
</head>
<body>
<div id="app">
  <h1>Chess.org Login</h1>

  <!-- Username input with CAPTCHA -->
  <div id="frontPage">
    <input type="text" id="nameInput" placeholder="Enter your name (max 20 chars)" maxlength="20" autocomplete="off" />
    <div id="captchaContainer" style="margin-bottom:1rem;">
      <canvas id="captchaCanvas" width="150" height="50" style="background:#fff; display:block; margin-bottom:0.5rem;"></canvas>
      <input type="text" id="captchaInput" placeholder="Enter CAPTCHA" autocomplete="off" />
      <button id="refreshCaptcha">Refresh CAPTCHA</button>
    </div>
    <button id="proceedBtn">Proceed</button>
  </div>

  <!-- Chat choice -->
  <div id="chatChoicePage" class="hidden">
    <button id="createLobbyBtn">Create Lobby</button>
    <input type="text" id="joinLobbyInput" placeholder="Enter lobby code (6 letters)" maxlength="6" style="text-transform:uppercase;" />
    <button id="joinLobbyBtn">Join Lobby</button>
    <button id="joinGlobalBtn">Join Global Chat</button>
  </div>

  <!-- Lobby chat -->
  <div id="lobbyPage" class="hidden">
    <div id="lobbyHeader">
      Lobby Code: <span id="lobbyCode"></span>
      <span id="playerCount">Players: 0</span>
    </div>
    <div id="messages"></div>
    <div id="chatInput" style="display:flex; gap:0.5rem;">
      <input type="text" id="chatMessageInput" placeholder="Type your message..." maxlength="200" style="flex-grow:1;" />
      <button id="sendMessageBtn">Send</button>
      <button id="clearChatBtn">Clear Chat</button>
    </div>
    <button id="leaveLobbyBtn" style="background:#e53e3e;">Leave Lobby</button>
  </div>

  <!-- Global chat -->
  <div id="globalPage" class="hidden">
    <h2 style="text-align:center;">Global Chat</h2>
    <div id="globalMessages"></div>
    <div id="globalChatInput" style="display:flex; gap:0.5rem;">
      <input type="text" id="globalMessageInput" placeholder="Type your message..." maxlength="200" style="flex-grow:1;" />
      <button id="sendGlobalMessageBtn">Send</button>
    </div>
    <button id="leaveGlobalBtn" style="background:#e53e3e;">Leave Global Chat</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAdssAURPfxQKdi7KbAlSisH0j34J8A144",
    authDomain: "landkit-5e55b.firebaseapp.com",
    projectId: "landkit-5e55b",
    storageBucket: "landkit-5e55b.appspot.com",
    messagingSenderId: "920665056429",
    appId: "1:920665056429:web:c3c134404d735df9275224"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Elements
  const nameInput = document.getElementById('nameInput');
  const proceedBtn = document.getElementById('proceedBtn');
  const frontPage = document.getElementById('frontPage');
  const chatChoicePage = document.getElementById('chatChoicePage');
  const createLobbyBtn = document.getElementById('createLobbyBtn');
  const joinLobbyInput = document.getElementById('joinLobbyInput');
  const joinLobbyBtn = document.getElementById('joinLobbyBtn');
  const joinGlobalBtn = document.getElementById('joinGlobalBtn');
  const lobbyPage = document.getElementById('lobbyPage');
  const lobbyCodeSpan = document.getElementById('lobbyCode');
  const playerCountSpan = document.getElementById('playerCount');
  const messagesDiv = document.getElementById('messages');
  const chatMessageInput = document.getElementById('chatMessageInput');
  const sendMessageBtn = document.getElementById('sendMessageBtn');
  const clearChatBtn = document.getElementById('clearChatBtn');
  const leaveLobbyBtn = document.getElementById('leaveLobbyBtn');
  const globalPage = document.getElementById('globalPage');
  const globalMessagesDiv = document.getElementById('globalMessages');
  const globalMessageInput = document.getElementById('globalMessageInput');
  const sendGlobalMessageBtn = document.getElementById('sendGlobalMessageBtn');
  const leaveGlobalBtn = document.getElementById('leaveGlobalBtn');

  // CAPTCHA
  const captchaCanvas = document.getElementById('captchaCanvas');
  const captchaInput = document.getElementById('captchaInput');
  const refreshCaptchaBtn = document.getElementById('refreshCaptcha');
  let captchaText = '';

  function generateCaptcha() {
    const ctx = captchaCanvas.getContext('2d');
    ctx.clearRect(0,0,captchaCanvas.width,captchaCanvas.height);
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    captchaText = '';
    for(let i=0;i<5;i++){ captchaText += chars[Math.floor(Math.random()*chars.length)]; }
    ctx.font = '30px Arial'; ctx.fillStyle = '#000';
    ctx.fillText(captchaText, 20, 35);
  }
  refreshCaptchaBtn.addEventListener('click', generateCaptcha);
  generateCaptcha();

  // Bad words list (partial example)
  const badWords = ['abbo','abo','abortion','ass','bitch','cunt','fuck','shit','nigger']; // etc
  function censor(text) {
    let censored = text;
    badWords.forEach(word => {
      const regex = new RegExp(`\\b${word}\\b`, 'gi');
      censored = censored.replace(regex,'****');
    });
    return censored;
  }

  // State
  let username = null;
  let currentLobby = null;
  let lastClear = 0; // timestamp for cooldown

  // Proceed button with CAPTCHA check
  proceedBtn.addEventListener('click', () => {
    const val = nameInput.value.trim();
    if(!val || val.length > 20){ alert('Enter valid name'); return; }
    if(captchaInput.value.trim().toUpperCase() !== captchaText){ alert('CAPTCHA incorrect'); generateCaptcha(); return; }
    username = val;
    frontPage.classList.add('hidden');
    chatChoicePage.classList.remove('hidden');
  });

  // Send lobby message
  sendMessageBtn.addEventListener('click', async () => {
    if(!chatMessageInput.value.trim()) return;
    const text = censor(chatMessageInput.value.trim());
    await db.collection('lobbies').doc(currentLobby).collection('messages').add({
      username, text, timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    chatMessageInput.value = '';
  });

  // Clear chat button
  clearChatBtn.addEventListener('click', async () => {
    const now = Date.now();
    if(now - lastClear < 10*60*1000){ alert('Wait 10 minutes between clears'); return; }
    if(!currentLobby) return;
    const snapshot = await db.collection('lobbies').doc(currentLobby).collection('messages').get();
    const batch = db.batch();
    snapshot.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    lastClear = now;
    alert('Chat cleared for everyone');
  });

  // Other chat, lobby join, global chat, etc. remains similar
</script>
</body>
</html>
